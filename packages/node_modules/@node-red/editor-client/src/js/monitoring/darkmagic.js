RED.monitoring = (function () {
    var data = {};

    function darkmagic() {
        RED.nodes.eachNode(function (node) {
            data[node.id] = {values: [], type: ""};

            injectHTMLIntoNode(node.id);
        });

        subscribeMonitoring();
    }

    function injectHTMLIntoNode(nodeId) {
        var nodeElement = document.getElementById(nodeId);
        var foreign = document.createElementNS('http://www.w3.org/2000/svg', "foreignObject");
        foreign.setAttribute('width', nodeElement.querySelector(".red-ui-flow-node").getAttribute('width'));
        foreign.setAttribute('height', 170);
        foreign.setAttribute('x', 0);
        foreign.setAttribute('y', 30);

        var iDiv = document.createElement('div');
        iDiv.setAttribute('id', "monitoring-" + nodeId);
        iDiv.setAttribute('style', "border:1px green solid;");
        iDiv.innerHTML = '<div> Im a div inside a SVG.' +
            '<img src="https://media.makeameme.org/created/dark-magics-going.jpg" alt="Italian Trulli">' +
            '</div>';

        foreign.appendChild(iDiv);
        nodeElement.appendChild(foreign);
    }

    function subscribeMonitoring() {
        RED.comms.subscribe("monitoring", function (topic, event) {
            var nodeId = event.id;
            var value = event.value.payload;

            if (!data[nodeId].type) data[nodeId].type = typeof (value);
            var timestamp = new Date();
            data[nodeId].values.push({x: timestamp, y: value});

            var divNode = document.getElementById("monitoring-" + nodeId);
            divNode.innerHTML = '<div>' +
                '<span>Value: ' + value + '</span><br>' +
                '<span>Time: ' + timestamp.toLocaleString() + '</span><br>' +
                '</div>';

            if (typeof (value) == "number")
                drawGraphic(nodeId, divNode)
        });
    }

    function drawGraphic(nodeId, divNode) {
        divNode.innerHTML += '<canvas id="chart-' + nodeId + '" width="' + divNode.getAttribute('width') + '" height="130"></canvas>';
        var ctx = document.getElementById('chart-' + nodeId).getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data[nodeId].values.map(function (value) {
                    return value.x;
                }),
                datasets: [{
                    label: 'Value',
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: data[nodeId].values.map(function (value) {
                        return value.y;
                    })
                }]
            },
            options: {
                legend: {
                    display: false,
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'series',
                        time: {
                            unit: 'second'
                        }
                    }]
                }
            }
        });
    }

    return {
        darkmagic: darkmagic,
        data: data
    }
})();