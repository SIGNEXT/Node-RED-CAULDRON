RED.monitoring = (function () {
    var data = {};

    function darkmagic() {
        RED.nodes.eachNode(function (node) {
            //msg: {x: timestamp, y:value, type: type}
            data[node.id] = {
                input: [],
                output: [],
                settings: {}
            };

            RED.monitoring.view.injectHTMLIntoNode(node.id, node.tostatus);
        });

        subscribeMonitoring();

        RED.monitoring.view.addMonitoringModal();
    }

    function subscribeMonitoring() {
        RED.comms.subscribe("monitoring", function (topic, event) {
            var nodeId = event.id;
            var dataReceived = event.value;
            var eventType = event.type;

            var timestamp = new Date();

            if (Array.isArray(dataReceived)) {
                dataReceived.map(function (msg, index) {
                    if (!msg) return;

                    if (!data[nodeId][eventType][index]) data[nodeId][eventType][index] = [];

                    if (Array.isArray(msg)) {
                        msg.map(function (el) {
                            var value = el.payload;
                            data[nodeId][eventType][index].push({x: timestamp, y: value, type: typeof (value)});
                            RED.monitoring.view.updateHTMLNode(nodeId, value, timestamp, eventType);
                        });
                    } else {
                        var value = msg.payload;
                        data[nodeId][eventType][index].push({x: timestamp, y: value, type: typeof (value)});
                        RED.monitoring.view.updateHTMLNode(nodeId, value, timestamp, eventType);
                    }
                });
            } else {
                var value = dataReceived.payload;
                data[nodeId][eventType].push({x: timestamp, y: value, type: typeof (value)});
                RED.monitoring.view.updateHTMLNode(nodeId, value, timestamp, eventType);
            }

        });
    }

    return {
        darkmagic: darkmagic,
        data: data
    }
})();